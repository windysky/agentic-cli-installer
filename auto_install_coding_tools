#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Initialize conda for this shell
# Try to find conda.sh and activate it
if [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
    source "$HOME/miniconda3/etc/profile.d/conda.sh"
elif [ -f "$HOME/anaconda3/etc/profile.d/conda.sh" ]; then
    source "$HOME/anaconda3/etc/profile.d/conda.sh"
elif command -v conda >/dev/null 2>&1 && [ -f "$(dirname "$(command -v conda)")/../etc/profile.d/conda.sh" ]; then
    source "$(dirname "$(command -v conda)")/../etc/profile.d/conda.sh"
else
    echo "Error: Could not find conda.sh to initialize conda"
    exit 1
fi

# Get list of conda environments, excluding 'base' (exact match only)
envs=$(conda env list | grep -v "^#" | awk '{print $1}' | grep -v "^$" | awk '$1 != "base"')

INSTALLER_SH="${INSTALLER_SH:-}"
if [[ -z "$INSTALLER_SH" ]]; then
    if [[ -x "${SCRIPT_DIR}/install_coding_tools.sh" ]]; then
        INSTALLER_SH="${SCRIPT_DIR}/install_coding_tools.sh"
    else
        installer_on_path=$(command -v install_coding_tools.sh 2>/dev/null || true)
        if [[ -n "${installer_on_path:-}" && -x "$installer_on_path" ]]; then
            INSTALLER_SH="$installer_on_path"
        else
            INSTALLER_SH="${SCRIPT_DIR}/install_coding_tools.sh"
        fi
    fi
fi

if [[ ! -x "$INSTALLER_SH" ]]; then
    echo "Error: install script not found or not executable: $INSTALLER_SH"
    exit 1
fi

# Loop through each environment and run install_coding_tools.sh
for env in $envs; do
    echo "Activating environment: $env"
    # Conda activation scripts can rely on unset variables; temporarily disable nounset
    set +u
    conda activate "$env"
    set -u
    "$INSTALLER_SH" --yes
    set +u
    conda deactivate
    set -u
    echo "Finished processing: $env"
    echo ""
done

echo "All environments processed."
